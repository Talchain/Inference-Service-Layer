# ISL Monitoring Setup Guide

## Overview

This guide explains how to deploy and configure Prometheus + Grafana monitoring for the Inference Service Layer (ISL). The monitoring stack provides real-time visibility into:

- **Request Metrics**: Throughput, latency, error rates
- **Business Metrics**: Queries generated, belief updates, causal analyses
- **Resource Metrics**: Active requests, cache performance
- **Service Health**: Uptime, Redis connectivity
- **Alerts**: Automated notifications for critical conditions

---

## Quick Start (Docker Compose)

### Prerequisites

- Docker 20.10+ and Docker Compose 2.0+
- ISL running and accessible (default: `http://localhost:8000`)

### 1. Start Monitoring Stack

```bash
cd monitoring
docker-compose -f docker-compose.monitoring.yml up -d
```

This starts:
- **Prometheus** on `http://localhost:9090`
- **Grafana** on `http://localhost:3000`
- **Node Exporter** on `http://localhost:9100` (optional system metrics)

### 2. Access Grafana

1. Open `http://localhost:3000`
2. Login with default credentials:
   - **Username**: `admin`
   - **Password**: `admin`
3. You'll be prompted to change the password (recommended for production)

### 3. View Dashboard

Navigate to **Dashboards â†’ Browse â†’ Inference Service Layer â†’ ISL Overview**

The dashboard shows:
- Service status and request rate
- Request latency (P50, P95, P99)
- Error rates and types
- Business metrics (queries, analyses, teaching)
- Cache performance
- Computation performance

### 4. Verify Metrics Collection

Check Prometheus is scraping metrics:
1. Open `http://localhost:9090`
2. Go to **Status â†’ Targets**
3. Verify `isl-api` target is **UP**

---

## Configuration

### Adjusting Scrape Interval

Edit `monitoring/prometheus/prometheus.yml`:

```yaml
global:
  scrape_interval: 15s  # Change to 10s for more frequent scraping
```

Restart Prometheus:
```bash
docker-compose -f docker-compose.monitoring.yml restart prometheus
```

### Customizing Alerts

Edit `monitoring/prometheus/alerts.yml` to add or modify alerts:

```yaml
- alert: MyCustomAlert
  expr: isl_some_metric > threshold
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "Custom alert fired"
    description: "Details about the alert"
```

Reload alerts without restart:
```bash
curl -X POST http://localhost:9090/-/reload
```

### Connecting to Remote ISL

If ISL is running on a different host, update `prometheus.yml`:

```yaml
scrape_configs:
  - job_name: 'isl-api'
    static_configs:
      - targets: ['your-isl-host:8000']  # Change this
```

---

## Available Metrics

### HTTP Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `isl_http_requests_total` | Counter | Total HTTP requests by method, endpoint, status |
| `isl_http_request_duration_seconds` | Histogram | Request latency distribution |
| `isl_http_errors_total` | Counter | Total HTTP errors by endpoint and code |
| `isl_active_requests` | Gauge | Currently active requests |

### Business Metrics - Preference Learning

| Metric | Type | Description |
|--------|------|-------------|
| `isl_preference_queries_generated_total` | Counter | Queries generated by strategy |
| `isl_belief_updates_total` | Counter | Belief updates performed |

### Business Metrics - Causal Inference

| Metric | Type | Description |
|--------|------|-------------|
| `isl_causal_validations_total` | Counter | Causal model validations by status |
| `isl_counterfactual_analyses_total` | Counter | Counterfactual analyses performed |

### Business Metrics - Teaching

| Metric | Type | Description |
|--------|------|-------------|
| `isl_teaching_examples_generated_total` | Counter | Teaching examples by concept |

### Business Metrics - Validation

| Metric | Type | Description |
|--------|------|-------------|
| `isl_model_validations_total` | Counter | Model validations by quality level |

### Cache Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `isl_cache_hits_total` | Counter | Cache hits |
| `isl_cache_misses_total` | Counter | Cache misses |
| `isl_redis_operations_total` | Counter | Redis operations by type and status |
| `isl_redis_connected` | Gauge | Redis connection status (1=connected, 0=disconnected) |

### Computation Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `isl_activa_computation_duration_seconds` | Histogram | ActiVA algorithm computation time |
| `isl_bayesian_update_duration_seconds` | Histogram | Bayesian belief update time |
| `isl_counterfactual_computation_duration_seconds` | Histogram | Counterfactual analysis time |

### Service Health

| Metric | Type | Description |
|--------|------|-------------|
| `isl_service_up` | Gauge | Service is up (1) or down (0) |

---

## Alert Rules

### Critical Alerts

| Alert | Condition | Action |
|-------|-----------|--------|
| `ISLServiceDown` | Service down for 1+ min | Immediate investigation required |
| `ISLVeryHighLatency` | P95 latency > 5s for 2+ min | Check for performance bottlenecks |

### Warning Alerts

| Alert | Condition | Action |
|-------|-----------|--------|
| `ISLHighErrorRate` | Error rate > 5% for 5+ min | Review logs for error patterns |
| `ISLHighLatency` | P95 latency > 2s for 5+ min | Monitor performance trends |
| `ISLRedisDisconnected` | Redis disconnected for 2+ min | Check Redis service and network |
| `ISLHighActiveRequests` | Active requests > 100 for 5+ min | May indicate bottleneck or traffic surge |
| `ISLNoRequestsReceived` | No requests for 10+ min | Check if service is accessible |

### Info Alerts

| Alert | Condition | Action |
|-------|-----------|--------|
| `ISLLowCacheHitRate` | Cache hit rate < 20% for 10+ min | Consider increasing cache TTL or capacity |

---

## Querying Metrics

### Useful PromQL Queries

#### Request Rate by Endpoint
```promql
sum(rate(isl_http_requests_total[5m])) by (endpoint)
```

#### P95 Latency
```promql
histogram_quantile(0.95,
  sum(rate(isl_http_request_duration_seconds_bucket[5m])) by (le, endpoint)
)
```

#### Error Rate Percentage
```promql
(sum(rate(isl_http_errors_total[5m])) / sum(rate(isl_http_requests_total[5m]))) * 100
```

#### Cache Hit Rate
```promql
sum(rate(isl_cache_hits_total[5m])) /
(sum(rate(isl_cache_hits_total[5m])) + sum(rate(isl_cache_misses_total[5m])))
```

#### Top 5 Slowest Endpoints
```promql
topk(5,
  histogram_quantile(0.95,
    sum(rate(isl_http_request_duration_seconds_bucket[10m])) by (le, endpoint)
  )
)
```

---

## Production Deployment

### Security Considerations

1. **Change Default Passwords**
   ```bash
   # Update docker-compose.monitoring.yml
   GF_SECURITY_ADMIN_PASSWORD=your-secure-password
   ```

2. **Enable HTTPS**
   - Configure reverse proxy (nginx/traefik) with SSL/TLS
   - Update Grafana root URL accordingly

3. **Restrict Access**
   - Use firewall rules to limit access to monitoring ports
   - Consider VPN or bastion host for external access

4. **Secure Prometheus**
   - Enable basic auth if exposing externally
   - Use service-to-service authentication

### Resource Requirements

**Minimum (Pilot)**:
- Prometheus: 512 MB RAM, 1 CPU, 10 GB storage
- Grafana: 256 MB RAM, 0.5 CPU, 1 GB storage

**Recommended (Production)**:
- Prometheus: 2 GB RAM, 2 CPU, 50 GB SSD storage
- Grafana: 1 GB RAM, 1 CPU, 5 GB storage

### Data Retention

Configure retention period in `docker-compose.monitoring.yml`:

```yaml
command:
  - '--storage.tsdb.retention.time=30d'  # Keep 30 days of data
```

For longer retention, consider:
- Increasing disk space
- Using remote storage (e.g., Thanos, Cortex)
- Downsampling old data

### High Availability

For production HA setup:

1. **Prometheus**: Use federation or Thanos for multi-instance setup
2. **Grafana**: Deploy multiple instances behind load balancer
3. **Alertmanager**: Cluster multiple instances for alert routing

---

## Troubleshooting

### Metrics Not Showing

**Problem**: No data in Grafana dashboards

**Solutions**:
1. Check ISL is running: `curl http://localhost:8000/health`
2. Check metrics endpoint: `curl http://localhost:8000/metrics`
3. Verify Prometheus target is UP: `http://localhost:9090/targets`
4. Check Prometheus logs: `docker logs isl-prometheus`

### High Cardinality Warnings

**Problem**: Prometheus warns about high cardinality

**Solution**:
- Avoid using high-cardinality labels (e.g., user IDs, request IDs)
- Use hashed user IDs instead of raw IDs
- Limit label value count

### Grafana Connection Error

**Problem**: Grafana can't connect to Prometheus

**Solutions**:
1. Verify both containers are on same network:
   ```bash
   docker network inspect isl-monitoring
   ```
2. Check Prometheus is accessible from Grafana:
   ```bash
   docker exec isl-grafana wget -O- http://prometheus:9090/-/healthy
   ```

### Alerts Not Firing

**Problem**: Expected alerts are not firing

**Solutions**:
1. Check alert rules syntax: http://localhost:9090/rules
2. Verify alert state: http://localhost:9090/alerts
3. Check alert evaluation: Look for `PENDING` or `FIRING` states
4. Review Prometheus logs for errors

---

## Integration with CEE

### Embedding Grafana Dashboards

CEE can embed Grafana panels for real-time monitoring:

```html
<iframe
  src="http://localhost:3000/d/isl-overview/inference-service-layer-overview?orgId=1&refresh=30s&kiosk"
  width="100%"
  height="600"
  frameborder="0">
</iframe>
```

### API-Based Metrics Access

Query Prometheus API programmatically:

```python
import requests

# Get current request rate
response = requests.get(
    'http://localhost:9090/api/v1/query',
    params={'query': 'sum(rate(isl_http_requests_total[5m]))'}
)
data = response.json()
request_rate = data['data']['result'][0]['value'][1]
print(f"Current request rate: {request_rate} req/s")
```

---

## Maintenance

### Backup Configuration

```bash
# Backup Prometheus data
docker cp isl-prometheus:/prometheus ./prometheus-backup

# Backup Grafana dashboards
docker cp isl-grafana:/var/lib/grafana ./grafana-backup
```

### Update Monitoring Stack

```bash
cd monitoring
docker-compose -f docker-compose.monitoring.yml pull
docker-compose -f docker-compose.monitoring.yml up -d
```

### Clean Up Old Data

```bash
# Stop services
docker-compose -f docker-compose.monitoring.yml down

# Remove volumes (WARNING: deletes all metrics data)
docker volume rm isl-prometheus-data isl-grafana-data

# Restart
docker-compose -f docker-compose.monitoring.yml up -d
```

---

## References

- [Prometheus Documentation](https://prometheus.io/docs/)
- [Grafana Documentation](https://grafana.com/docs/)
- [PromQL Tutorial](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Alerting Best Practices](https://prometheus.io/docs/practices/alerting/)

---

## Support

For monitoring-related issues:
1. Check ISL logs: `docker logs isl-api`
2. Check Prometheus logs: `docker logs isl-prometheus`
3. Check Grafana logs: `docker logs isl-grafana`
4. Review metrics endpoint: `http://localhost:8000/metrics`

**Monitoring Setup Complete!** ðŸŽ‰

The ISL monitoring stack provides comprehensive visibility into service health, performance, and business metrics, enabling proactive incident response and data-driven optimization.
