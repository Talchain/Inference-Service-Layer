name: Deploy ISL to Production

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install

      - name: Run tests
        run: poetry run pytest --cov --cov-report=xml --cov-report=term

      - name: Check test coverage
        run: |
          COVERAGE=$(poetry run coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "‚ùå Coverage $COVERAGE% below 80% threshold"
            exit 1
          fi
          echo "‚úì Coverage $COVERAGE% meets 80% threshold"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # NOTE: Security checks are handled by .github/workflows/security.yml
  # which runs blocking checks (pip-audit, semgrep, gitleaks, bandit)

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install

      - name: Run linters
        run: |
          poetry run black --check src/ tests/
          # Full ruff check (not just imports) to catch real issues
          poetry run ruff check src/ tests/
          poetry run mypy src/

  deploy-staging:
    needs: [test, lint]
    if: github.ref == 'refs/heads/main' || inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install smoke test dependencies
        run: poetry install --only main --with test --no-interaction

      - name: Deploy to Render (Staging)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
        run: |
          echo "Deploying to staging..."
          DEPLOY_RESPONSE=$(curl -X POST \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}')

          echo "Deploy triggered: $DEPLOY_RESPONSE"

      - name: Wait for deployment
        run: |
          echo "Waiting 60 seconds for deployment..."
          sleep 60

      - name: Health check
        run: |
          echo "Running health checks..."
          for i in {1..10}; do
            if curl -f https://isl-staging.onrender.com/health; then
              echo "‚úì Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, waiting..."
            sleep 10
          done
          echo "‚ùå Health check failed after 10 attempts"
          exit 1

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          poetry run pytest tests/smoke/ \
            --base-url=https://isl-staging.onrender.com \
            --api-key=${{ secrets.ISL_STAGING_API_KEY }} \
            -v

      - name: Notify team
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'ISL deployed to staging'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,commit,author,action,eventName,ref,workflow

  deploy-production:
    needs: [test, lint, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') || inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install smoke test dependencies
        run: poetry install --only main --with test --no-interaction

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
          body: |
            ## ISL Production Release

            ### Changes
            See [CHANGELOG.md](CHANGELOG.md) for details.

            ### Deployment
            - Staging validated ‚úì
            - Tests passing ‚úì
            - Security scan complete ‚úì

            ### Monitoring
            - Dashboard: https://grafana.olumi.com/d/isl-overview
            - Metrics: https://prometheus.olumi.com

      - name: Deploy to Render (Production)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_PROD_SERVICE_ID }}
        run: |
          echo "üöÄ Deploying to production..."
          DEPLOY_RESPONSE=$(curl -X POST \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": true}')

          echo "Production deploy triggered: $DEPLOY_RESPONSE"

      - name: Wait for deployment
        run: |
          echo "Waiting 90 seconds for production deployment..."
          sleep 90

      - name: Health check
        run: |
          echo "Running production health checks..."
          for i in {1..10}; do
            if curl -f https://isl.olumi.com/health; then
              echo "‚úì Production health check passed"
              exit 0
            fi
            echo "Attempt $i failed, waiting..."
            sleep 10
          done
          echo "‚ùå Production health check failed"
          exit 1

      - name: Run smoke tests
        run: |
          echo "Running production smoke tests..."
          poetry run pytest tests/smoke/ \
            --base-url=https://isl.olumi.com \
            --api-key=${{ secrets.ISL_PROD_API_KEY }} \
            -v

      - name: Update monitoring
        run: |
          echo "Updating Grafana annotation..."
          curl -X POST https://grafana.olumi.com/api/annotations \
            -H "Authorization: Bearer ${{ secrets.GRAFANA_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ISL Production Deployment - ${{ github.ref }}\",
              \"tags\": [\"deployment\", \"isl\", \"production\"],
              \"time\": $(date +%s)000
            }" || echo "Failed to create Grafana annotation"

      - name: Notify team (Success)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'üéâ ISL deployed to production successfully!',
              attachments: [{
                color: 'good',
                text: `Version: ${{ github.ref }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}`,
                fields: [{
                  title: 'Dashboard',
                  value: 'https://grafana.olumi.com/d/isl-overview'
                }]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify team (Failure)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'üö® ISL production deployment FAILED!',
              attachments: [{
                color: 'danger',
                text: `Version: ${{ github.ref }}\nCommit: ${{ github.sha }}\n\nRequires immediate attention!`,
                fields: [{
                  title: 'Action',
                  value: 'Check GitHub Actions logs and consider rollback'
                }]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Create deployment record
        if: always()
        run: |
          echo "Recording deployment..."
          curl -X POST https://api.olumi.com/deployments \
            -H "Authorization: Bearer ${{ secrets.OLUMI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"service\": \"isl\",
              \"version\": \"${{ github.ref }}\",
              \"environment\": \"production\",
              \"status\": \"${{ job.status }}\",
              \"deployed_by\": \"${{ github.actor }}\",
              \"commit_sha\": \"${{ github.sha }}\"
            }" || echo "Failed to record deployment"
