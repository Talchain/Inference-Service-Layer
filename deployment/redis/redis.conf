# Production Redis Configuration for ISL
#
# This configuration provides:
# - Persistence (RDB + AOF)
# - Memory optimization
# - Security hardening
# - Connection pooling
# - Monitoring

# Network
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 300
tcp-keepalive 300

# Security
# requirepass your-secure-password-here  # IMPORTANT: Set this in production
protected-mode yes

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# Memory Management
maxmemory 512mb
maxmemory-policy allkeys-lru  # Evict least recently used keys when memory full
maxmemory-samples 5

# Persistence - RDB (Snapshots)
save 900 1      # Save if 1 key changed in 900 seconds
save 300 10     # Save if 10 keys changed in 300 seconds
save 60 10000   # Save if 10000 keys changed in 60 seconds

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# Persistence - AOF (Append Only File)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec  # Fsync every second (good balance of safety/performance)
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes  # Use RDB format for AOF rewrites (faster)

# Logging
loglevel notice
logfile ""  # Log to stdout for container environments

# Client Limits
maxclients 10000

# Slow Log (for debugging slow queries)
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128

# Latency Monitoring
latency-monitor-threshold 100  # Monitor operations taking > 100ms

# Performance Tuning
hz 10  # Background task frequency
dynamic-hz yes
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Replication (for HA setup)
# replica-read-only yes
# min-replicas-to-write 1
# min-replicas-max-lag 10

# TLS/SSL (for production encryption)
# port 0  # Disable non-TLS port
# tls-port 6379
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt
# tls-auth-clients no
